// Auto-generated by mernpkg
const { app, BrowserWindow, ipcMain, Menu, shell } = require('electron');
const path = require('path');
const https = require('https');
const http = require('http');

let mainWindow;
let pendingDesktopToken = null;
let desktopSessionPayload = null;

const ICON_PATH = path.join(__dirname, 'logo_only.ico');
const SPLASH_HTML_BASE64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0iVVRGLTgiIC8+CiAgPHRpdGxlPlNhcnR0aGkgRGVza3RvcDwvdGl0bGU+CiAgPHN0eWxlPgogICAgKiB7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IH0KICAgIGJvZHkgewogICAgICBtYXJnaW46IDA7CiAgICAgIGZvbnQtZmFtaWx5OiAnSW50ZXInLCBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgc2Fucy1zZXJpZjsKICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCB0b3AsICMxMTEzMWYsICMwNzA4MGUpOwogICAgICBjb2xvcjogI2Y0ZjRmNDsKICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICB9CiAgICAuY2FyZCB7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoNyw4LDE0LDAuOSk7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LDIyOCwxMjgsMC4xMik7CiAgICAgIGJvcmRlci1yYWRpdXM6IDIycHg7CiAgICAgIHBhZGRpbmc6IDQ4cHg7CiAgICAgIHdpZHRoOiA0MjBweDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMThweCk7CiAgICAgIGJveC1zaGFkb3c6IDAgMjVweCA4MHB4IHJnYmEoMCwwLDAsMC42NSk7CiAgICB9CiAgICAubG9nbyB7CiAgICAgIGZvbnQtc2l6ZTogMjhweDsKICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgbWFyZ2luLWJvdHRvbTogMThweDsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICAgIGdhcDogMTBweDsKICAgICAgY29sb3I6ICNmZmRmNWI7CiAgICB9CiAgICBwIHsKICAgICAgbWFyZ2luOiAwIDAgMjhweDsKICAgICAgY29sb3I6IHJnYmEoMjQ0LDI0NCwyNDQsMC44NSk7CiAgICAgIGxpbmUtaGVpZ2h0OiAxLjU7CiAgICB9CiAgICBidXR0b24gewogICAgICB3aWR0aDogMTAwJTsKICAgICAgcGFkZGluZzogMTRweCAxOHB4OwogICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgIGJvcmRlci1yYWRpdXM6IDE0cHg7CiAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXdlaWdodDogNjAwOwogICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4ycyBlYXNlLCBib3gtc2hhZG93IDAuMnMgZWFzZSwgYmFja2dyb3VuZCAwLjJzIGVhc2U7CiAgICAgIG1hcmdpbi1ib3R0b206IDE0cHg7CiAgICB9CiAgICBidXR0b24ucHJpbWFyeSB7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNmZmQ3NTUsICNmN2I3MzMpOwogICAgICBjb2xvcjogIzEyMGYxZjsKICAgICAgYm94LXNoYWRvdzogMCAxOHB4IDM4cHggcmdiYSgyNDcsMTgzLDUxLDAuMzUpOwogICAgfQogICAgYnV0dG9uLnNlY29uZGFyeSB7CiAgICAgIGJhY2tncm91bmQ6IHJnYmEoMjAsMjMsMzIsMC45KTsKICAgICAgY29sb3I6ICNmNGY0ZjQ7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LDIxNSw4NSwwLjI1KTsKICAgIH0KICAgIGJ1dHRvbjpob3ZlciB7CiAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsKICAgICAgYm94LXNoYWRvdzogMCAxMnB4IDMycHggcmdiYSgwLDAsMCwwLjQpOwogICAgfQogICAgLmN0YS1ub3RlIHsKICAgICAgZm9udC1zaXplOiAxM3B4OwogICAgICBtYXJnaW4tdG9wOiAxMHB4OwogICAgICBjb2xvcjogcmdiYSgyNDQsMjQ0LDI0NCwwLjU1KTsKICAgIH0KICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgPGRpdiBjbGFzcz0ibG9nbyI+CiAgICAgIDxzcGFuPuKaoTwvc3Bhbj4KICAgICAgPHNwYW4+U2FydHRoaSBEZXNrdG9wPC9zcGFuPgogICAgPC9kaXY+CiAgICA8cD5BdXRoZW50aWNhdGUgdGhyb3VnaCB0aGUgc2VjdXJlIFNhcnR0aGkgcG9ydGFsLiBDaG9vc2UgYW4gb3B0aW9uIGJlbG93IHRvIGNvbnRpbnVlIGluIHlvdXIgYnJvd3Nlci48L3A+CiAgICA8YnV0dG9uIGNsYXNzPSJwcmltYXJ5IiBvbmNsaWNrPSJ3aW5kb3cuZWxlY3Ryb25BUEkub3BlbkV4dGVybmFsKCdodHRwczovL3NhcnR0aGkuY29tL2xvZ2luP3NvdXJjZT1kZXNrdG9wJnJlZGlyZWN0PSUyRmRlc2t0b3AtaGFuZHNoYWtlJykiPkNvbnRpbnVlIHRvIExvZ2luPC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJzZWNvbmRhcnkiIG9uY2xpY2s9IndpbmRvdy5lbGVjdHJvbkFQSS5vcGVuRXh0ZXJuYWwoJ2h0dHBzOi8vc2FydHRoaS5jb20vcmVnaXN0ZXI/c291cmNlPWRlc2t0b3AmcmVkaXJlY3Q9JTJGZGVza3RvcC1oYW5kc2hha2UnKSI+Q3JlYXRlIGEgbmV3IGFjY291bnQ8L2J1dHRvbj4KICAgIDxkaXYgY2xhc3M9ImN0YS1ub3RlIj5BbHJlYWR5IHNpZ25lZCBpbj8gUmUtb3BlbiB0aGUgYXBwIGFmdGVyIGNvbXBsZXRpbmcgbG9naW4uPC9kaXY+CiAgPC9kaXY+CjwvYm9keT4KPC9odG1sPg==';
const SPLASH_DATA_URL = 'data:text/html;base64,' + SPLASH_HTML_BASE64;

const sanitizeBase = (value) => {
  if (typeof value !== 'string') return '';
  return value.endsWith('/') ? value.slice(0, -1) : value;
};

const FRONTEND_URL = sanitizeBase('https://sartthi.com');
const API_FALLBACKS = [
  "https://api.sartthi.com/api",
  "http://localhost:5000/api"
];
const CONFIGURED_API_BASE = sanitizeBase('https://sartthi.com/api');
const API_BASE_CANDIDATES = Array.from(
  new Set(
    [sanitizeBase(process.env.SAARTHI_API_BASE || ''), CONFIGURED_API_BASE]
      .concat(Array.isArray(API_FALLBACKS) ? API_FALLBACKS : [])
      .map(sanitizeBase)
      .filter(Boolean)
  )
);
const DESKTOP_SHELL_URL = FRONTEND_URL + '/desktop-shell?source=desktop';
const DESKTOP_REDIRECT_URL = FRONTEND_URL + '/home';
const DESKTOP_SESSION_EXCHANGE_PATH = '/auth/desktop-session/exchange';
const DESKTOP_PROTOCOL_SCHEME = 'sartthi-desktop:';
const DESKTOP_LOGIN_URL = FRONTEND_URL + '/login?source=desktop&redirect=%2Fdesktop-handshake';
const DESKTOP_REGISTER_URL = FRONTEND_URL + '/register?source=desktop&redirect=%2Fdesktop-handshake';

function postJson(targetUrl, body) {
  return new Promise((resolve, reject) => {
    try {
      const parsedUrl = new URL(targetUrl);
      const payload = JSON.stringify(body || {});
      const isHttps = parsedUrl.protocol === 'https:';
      const requestOptions = {
        method: 'POST',
        hostname: parsedUrl.hostname,
        port: parsedUrl.port || (isHttps ? 443 : 80),
        path: parsedUrl.pathname + parsedUrl.search,
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': Buffer.byteLength(payload)
        }
      };

      const request = (isHttps ? https : http).request(requestOptions, (response) => {
        let rawData = '';
        response.on('data', chunk => rawData += chunk);
        response.on('end', () => {
          try {
            const parsedBody = rawData ? JSON.parse(rawData) : {};
            resolve({ statusCode: response.statusCode, body: parsedBody });
          } catch (parseError) {
            reject(parseError);
          }
        });
      });

      request.on('error', reject);
      request.write(payload);
      request.end();
    } catch (error) {
      reject(error);
    }
  });
}

function getDesktopSessionPayloadSnapshot() {
  if (!desktopSessionPayload) return null;
  return {
    ...desktopSessionPayload,
    redirect: DESKTOP_REDIRECT_URL
  };
}

function consumeDesktopSessionPayload() {
  const payload = getDesktopSessionPayloadSnapshot();
  if (payload) {
    desktopSessionPayload = null;
  }
  return payload;
}

function emitDesktopSessionIfAvailable() {
  const payload = getDesktopSessionPayloadSnapshot();
  if (!payload || !mainWindow || mainWindow.isDestroyed()) return;
  mainWindow.webContents.send('saarthi-desktop-session', payload);
}

async function exchangeDesktopTokenWithBase(baseUrl, token) {
  if (!baseUrl) {
    throw new Error('Empty API base URL');
  }
  const exchangeUrl = baseUrl + DESKTOP_SESSION_EXCHANGE_PATH;
  const result = await postJson(exchangeUrl, { token });

  if (!result || result.statusCode < 200 || result.statusCode >= 300 || !result.body?.success || !result.body?.data) {
    throw new Error(result?.body?.message || ('Failed to exchange desktop session token via ' + exchangeUrl));
  }

  return result.body.data;
}

async function attemptDesktopSessionExchange(token) {
  if (!API_BASE_CANDIDATES.length) {
    throw new Error('No API base candidates configured for desktop session exchange');
  }

  let lastError;
  for (const base of API_BASE_CANDIDATES) {
    try {
      console.log('[Desktop] Attempting session exchange via ' + base);
      return await exchangeDesktopTokenWithBase(base, token);
    } catch (error) {
      lastError = error;
      console.error('[Desktop] Session exchange failed via ' + base + ':', error?.message || error);
    }
  }

  throw lastError || new Error('All desktop session exchange attempts failed');
}

async function handleDesktopToken(token) {
  if (!token) return;
  try {
    console.log('Processing desktop authentication token');
    const exchangeResult = await attemptDesktopSessionExchange(token);
    const { accessToken, refreshToken } = exchangeResult;
    desktopSessionPayload = {
      accessToken: accessToken || '',
      refreshToken: refreshToken || ''
    };

    if (mainWindow && !mainWindow.isDestroyed()) {
      await mainWindow.loadURL(DESKTOP_SHELL_URL);
      emitDesktopSessionIfAvailable();
    }
  } catch (error) {
    console.error('Desktop authentication failed:', error);
    if (mainWindow && !mainWindow.isDestroyed()) {
      const errorScript = "window.postMessage({ type: 'saarthi-desktop-auth-error', message: 'Desktop authentication failed. Please try again.' }, '*');";
      mainWindow.webContents.executeJavaScript(errorScript).catch(() => {});
    }
  }
}

function handleDesktopDeepLink(rawUrl) {
  if (!rawUrl) return;
  try {
    const parsed = new URL(rawUrl);
    if (parsed.protocol !== DESKTOP_PROTOCOL_SCHEME) {
      return;
    }

    const token = parsed.searchParams.get('token');
    if (!token) {
      return;
    }

    if (mainWindow && !mainWindow.isDestroyed()) {
      handleDesktopToken(token);
    } else {
      pendingDesktopToken = token;
    }
  } catch (error) {
    console.error('Failed to process desktop deep link:', error);
  }
}

function inspectArgsForDeepLink(argv = []) {
  const match = argv.find(arg => typeof arg === 'string' && arg.startsWith(DESKTOP_PROTOCOL_SCHEME));
  if (match) {
    handleDesktopDeepLink(match);
  }
}

if (process.defaultApp) {
  if (process.argv.length >= 2) {
    app.setAsDefaultProtocolClient('sartthi-desktop', process.execPath, [path.resolve(process.argv[1])]);
  }
} else {
  app.setAsDefaultProtocolClient('sartthi-desktop');
}

const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
  app.quit();
} else {
  app.on('second-instance', (_event, commandLine) => {
    if (mainWindow) {
      if (mainWindow.isMinimized()) mainWindow.restore();
      mainWindow.focus();
    }
    inspectArgsForDeepLink(commandLine);
  });

  app.on('open-url', (_event, deepLinkUrl) => {
    handleDesktopDeepLink(deepLinkUrl);
  });

  app.on('ready', () => {
    createWindow();
    inspectArgsForDeepLink(process.argv);
  });

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
}

function flushPendingToken() {
  if (pendingDesktopToken) {
    const token = pendingDesktopToken;
    pendingDesktopToken = null;
    handleDesktopToken(token);
  }
}

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    icon: ICON_PATH,
    show: false,
    backgroundColor: '#0B0F18',
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
      contextIsolation: true,
      nodeIntegration: false,
      sandbox: false
    }
  });

  Menu.setApplicationMenu(null);
  mainWindow.loadURL(SPLASH_DATA_URL);

  mainWindow.webContents.on('did-finish-load', () => {
    const currentUrl = mainWindow.webContents.getURL();
    if (currentUrl.startsWith(DESKTOP_SHELL_URL)) {
      emitDesktopSessionIfAvailable();
    }
  });

  mainWindow.once('ready-to-show', () => {
    mainWindow.show();
    flushPendingToken();
  });

  mainWindow.on('closed', () => {
    mainWindow = null;
  });
}

ipcMain.on('open-external', (_event, targetUrl) => {
  if (typeof targetUrl === 'string') {
    shell.openExternal(targetUrl);
  }
});

ipcMain.handle('saarthi-desktop-get-session', async () => {
  return consumeDesktopSessionPayload();
});

ipcMain.handle('saarthi-desktop-show-splash', async () => {
  desktopSessionPayload = null;
  pendingDesktopToken = null;
  if (!mainWindow || mainWindow.isDestroyed()) return;
  await mainWindow.loadURL(SPLASH_DATA_URL);
});

console.log('Electron main script loaded with desktop deep link handler');
